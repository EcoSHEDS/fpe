{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Root of nested stack",
  "Parameters": {
    "appName": {
      "Description": "Application name",
      "Type": "String",
      "Default": "myapp"
    },
    "env": {
      "Description": "Environment",
      "Type": "String",
      "Default": "dev"
    },
    "storageBucketName": {
      "Description": "Storage bucket name",
      "Type": "String"
    },
    "permissionsBoundaryName": {
      "Description": "Permissions boundary",
      "Type": "String",
      "Default": "NONE"
    },
    "vpcId": {
      "Description": "VPC ID",
      "Type": "String"
    },
    "publicSubnetIds": {
      "Description": "Public subnet IDs",
      "Type": "String"
    },
    "privateSubnetIds": {
      "Description": "Private subnet IDs",
      "Type": "String"
    },
    "dbSecretArn": {
      "Description": "Arn of secret for database credentials",
      "Type": "String"
    },
    "dbSecretName": {
      "Description": "Name of secret for database credentials",
      "Type": "String"
    }
  },
  "Resources": {
    "AuthStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "./auth.json",
        "Parameters": {
          "appName": { "Ref": "appName" },
          "env": { "Ref": "env" },
          "permissionsBoundaryName": { "Ref": "permissionsBoundaryName" }
        }
      }
    },
    "LambdaApiStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "./lambda-api-packaged.json",
        "Parameters": {
          "appName": { "Ref": "appName" },
          "env": { "Ref": "env" },
          "permissionsBoundaryName": { "Ref": "permissionsBoundaryName" },
          "vpcId": { "Ref": "vpcId" },
          "subnetIds": { "Ref": "privateSubnetIds" },
          "dbSecretArn": { "Ref": "dbSecretArn" },
          "dbSecretName": { "Ref": "dbSecretName" },
          "storageBucketName": { "Ref": "storageBucketName" },
          "lambdaWorkerName": {
            "Fn::GetAtt": [ "LambdaWorkerStack", "Outputs.LambdaName" ]
          },
          "batchJobDefinitionName": {
            "Fn::GetAtt": [ "BatchStack", "Outputs.JobDefinitionName" ]
          },
          "batchJobQueueName": {
            "Fn::GetAtt": [ "BatchStack", "Outputs.JobQueueName" ]
          },
          "userPoolId": {
            "Fn::GetAtt": [ "AuthStack", "Outputs.UserPoolId" ]
          }
        }
      }
    },
    "ApiStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "./api.json",
        "Parameters": {
          "appName": { "Ref": "appName" },
          "env": { "Ref": "env" },
          "userPoolId": {
            "Fn::GetAtt": [ "AuthStack", "Outputs.UserPoolId" ]
          },
          "lambdaName": {
            "Fn::GetAtt": [ "LambdaApiStack", "Outputs.LambdaName" ]
          }
        }
      }
    },
    "BatchStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "./batch.json",
        "Parameters": {
          "appName": { "Ref": "appName" },
          "env": { "Ref": "env" },
          "vpcId": { "Ref": "vpcId" },
          "subnetIds": { "Ref": "publicSubnetIds" },
          "dbSecretName": { "Ref": "dbSecretName" }
        }
      }
    },
    "LambdaWorkerStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "./lambda-worker-packaged.json",
        "Parameters": {
          "appName": { "Ref": "appName" },
          "env": { "Ref": "env" },
          "permissionsBoundaryName": { "Ref": "permissionsBoundaryName" },
          "vpcId": { "Ref": "vpcId" },
          "subnetIds": { "Ref": "privateSubnetIds" },
          "storageBucketName": { "Ref": "storageBucketName" }
        }
      }
    }
  },
  "Outputs": {
    "Region": {
      "Description": "Stack region",
      "Value": {
        "Ref": "AWS::Region"
      }
    },
    "IdentityPoolId": {
      "Description": "Identity pool ID",
      "Value": {
        "Fn::GetAtt": [ "AuthStack", "Outputs.IdentityPoolId" ]
      }
    },
    "UserPoolId": {
      "Description": "User pool ID",
      "Value": {
        "Fn::GetAtt": [ "AuthStack", "Outputs.UserPoolId" ]
      }
    },
    "UserPoolClientWebId": {
      "Description": "User pool client id for web app",
      "Value": {
        "Fn::GetAtt": [ "AuthStack", "Outputs.UserPoolClientWebId" ]
      }
    },
    "ApiRootUrl": {
      "Description": "Root URL for REST API",
      "Value": {
        "Fn::GetAtt": [ "ApiStack", "Outputs.ApiRootUrl" ]
      }
    },
    "StorageBucket": {
      "Description": "Storage bucket name",
      "Value": { "Ref": "storageBucketName" }
    }
  }
}